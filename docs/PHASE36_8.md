# Phase 36.8: Production Seed + Admin Login End-to-End

## 1. Objectives
- **Build Functionality**: Fix build failures caused by missing exports in `publicOrigin.ts` and non-portable `fs` imports in `transport.ts`.
- **Production Origin Enforcement**: Ensure strict `AUTH_BASE_URL` dependency in production (no `VERCEL_URL` leakage).
- **Magic Link Canon alization**: Ensure email links point to canonical origin and correct `/auth/consume` route.
- **Admin Access**: validate admin gating logic for the test organization.

## 2. Changes

### `lib/env/publicOrigin.ts`
- **Fixed**: Exported `assertPublicOriginValid` (missing caused build fail).
- **Strict Mode**: Production environments (`VERCEL_ENV=production`) now throw errors if `AUTH_BASE_URL` is not `https://www.inpsyq.com`.
- **Diagnostics**: Added `getOriginDiagnostics()` for admin debugging.

### `services/email/transport.ts`
- **Build Fix**: Moved `fs` and `path` imports inside `TestTransport` using `await import(...)`. This prevents generic build failures on Edge/Client runtimes even if not used.
- **Link Target**: Changed magic link target from `/api/auth/consume` (deprecated direct POST) to `/auth/consume` (Confirm Page).
- **Canonical Origin**: Forces usage of `getPublicOriginUrl()` for all links.

### `lib/admin/seedTestOrg.ts` (Phase 36.7)
- **Status**: Logic verified. Safe pruning of synthetic users and deterministic seeding. Uses dedicated `TEST_ORG_ID`.

## 3. Verification Scripts
New local verification scripts created:
- `scripts/verify_phase36_8_origin_invariants.ts`: Checks strict environment variable logic.
- `scripts/verify_phase36_8_magic_link_scanner_e2e_local.ts`: Verifies email transport generates correct links and writes to outbox.

## 4. Production Deployment Steps
1. **Push**: `git push origin production`
2. **Verify Build**: Ensure Vercel build succeeds.
3. **Seed Test Org**:
   - `curl -X POST https://www.inpsyq.com/api/internal/admin/test-org/ensure -H "Authorization: Bearer <SECRET>"`
   - `curl -X POST https://www.inpsyq.com/api/internal/admin/test-org/seed -H "Authorization: Bearer <SECRET>" -d '{"weeks": 6}'`
4. **Login**:
   - Go to `https://www.inpsyq.com/login`
   - Enter `oleboehme2006@gmail.com`
   - Check email (production will use Resend, ensure RESEND_API_KEY is active).

## 5. Artifacts
- `artifacts/email_outbox/last_magic_link.json`: Generated by local test runs.
